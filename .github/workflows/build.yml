name: Arcalm Linux Builder

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 */3 * *'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      arch_version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Get ISO version
        id: get_version
        run: |
          curl -sL https://mirrors.edge.kernel.org/archlinux/iso/latest/sha256sums.txt -o sha256sums.txt
          ISO_NAME=$(grep -oP 'archlinux-\K\d{4}\.\d{2}\.\d{2}(?=-x86_64.iso)' sha256sums.txt | head -1)
          echo "version=$ISO_NAME" >> $GITHUB_OUTPUT

      - name: Check releases
        id: check
        run: |
          API_RESPONSE=$(curl -sfH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/latest" || echo 'null')
          LATEST_RELEASE_TAG=$(jq -r .tag_name <<< "$API_RESPONSE")
          CURRENT_VERSION="${{ steps.get_version.outputs.version }}"

          if [[ "$LATEST_RELEASE_TAG" != "$CURRENT_VERSION" ]] || [[ "$API_RESPONSE" == 'null' ]]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "::notice::New version detected: $CURRENT_VERSION"
          else
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "::notice::No new version available"
          fi

  build-and-release:
    needs: check-version
    if: needs.check-version.outputs.new_version == 'true'
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
      options: --privileged
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify repository structure
        run: |
          echo "Workspace content:"
          ls -la .
          echo "Calamares configs:"
          ls -la calamares
          echo "Checking paths:"
          echo "Calamares directory: $(realpath calamares)"
          echo "customize_airootfs.sh path: $(realpath airootfs/root/customize_airootfs.sh)"

      - name: Setup environment
        run: |
          pacman -Sy --noconfirm archiso sudo git base-devel jq
          useradd builduser
          mkdir -p /build /work /out
          chown -R builduser:builduser /build /work /out

      - name: Prepare ISO config
        run: |
          cp -r /usr/share/archiso/configs/releng /build/custom-archiso
          cd /build/custom-archiso

          # Создаем mirrorlist с раскомментированными зеркалами из вашего файла
          cat <<EOF >> /etc/pacman.d/mirrorlist
Server = https://mirror.arctic.lol/ArchMirror/\$repo/os/\$arch
Server = https://mirror.5i.fi/archlinux/\$repo/os/\$arch
Server = https://mirror1.sl-chat.ru/archlinux/\$repo/os/\$arch
Server = https://mirror.srv.fail/archlinux/\$repo/os/\$arch
Server = https://mirror.wuki.li/archlinux/\$repo/os/\$arch
Server = https://arch.yhtez.xyz/\$repo/os/\$arch
Server = https://elda.asgardius.company/archlinux/\$repo/os/\$arch
Server = https://mirror.bakertelekom.fr/Arch/\$repo/os/\$arch
Server = https://fr.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://archmirror.hogwarts.fr/\$repo/os/\$arch
Server = https://mirror.its-tps.fr/archlinux/\$repo/os/\$arch
Server = https://mirror.jordanrey.me/archlinux/\$repo/os/\$arch
Server = https://mirrors.jtremesay.org/archlinux/\$repo/os/\$arch
Server = https://arch.juline.tech/\$repo/os/\$arch
Server = https://archlinux.mailtunnel.eu/\$repo/os/\$arch
Server = https://f.matthieul.dev/mirror/archlinux/\$repo/os/\$arch
Server = https://mirrors.celianvdb.fr/archlinux/\$repo/os/\$arch
Server = https://mirror.theo546.fr/archlinux/\$repo/os/\$arch
Server = https://mirror.trap.moe/archlinux/\$repo/os/\$arch
Server = https://mirror.wormhole.eu/archlinux/\$repo/os/\$arch
Server = https://arch.yourlabs.org/\$repo/os/\$arch
Server = https://archlinux.grena.ge/\$repo/os/\$arch
Server = https://mirror.23m.com/archlinux/\$repo/os/\$arch
Server = https://ftp.agdsn.de/pub/mirrors/archlinux/\$repo/os/\$arch
Server = https://mirrors.aminvakil.com/archlinux/\$repo/os/\$arch
Server = https://appuals.com/archlinux/\$repo/os/\$arch
Server = https://mirror.bethselamin.de/\$repo/os/\$arch
Server = https://de.arch.mirror.kescher.at/\$repo/os/\$arch
Server = https://mirror.kumi.systems/archlinux/\$repo/os/\$arch
Server = https://arch.kurdy.org/\$repo/os/\$arch
Server = https://mirror.fra10.de.leaseweb.net/archlinux/\$repo/os/\$arch
Server = https://mirror.metalgamer.eu/archlinux/\$repo/os/\$arch
Server = https://mirror.lcarilla.de/archlinux/\$repo/os/\$arch
Server = https://mirror.moson.org/arch/\$repo/os/\$arch
Server = https://mirrors.n-ix.net/archlinux/\$repo/os/\$arch
Server = https://mirror.netcologne.de/archlinux/\$repo/os/\$arch
Server = https://de.arch.niranjan.co/\$repo/os/\$arch
Server = https://mirrors.pseudoform.org/archlinux/\$repo/os/\$arch
Server = https://mirrors.purring.online/arch/\$repo/os/\$arch
Server = https://archlinux.richard-neumann.de/\$repo/os/\$arch
Server = https://mirror.hostart.az/archlinux/\$repo/os/\$arch
Server = https://mirror.ourhost.az/archlinux/\$repo/os/\$arch
Server = https://mirror.yer.az/archlinux/\$repo/os/\$arch
Server = https://mirror.xeonbd.com/archlinux/\$repo/os/\$arch
Server = https://archlinux.cu.be/\$repo/os/\$arch
Server = https://mirror.jonas-prz.be/\$repo/os/\$arch
Server = https://mirror.tiguinet.net/arch/\$repo/os/\$arch
Server = https://archlinux.c3sl.ufpr.br/\$repo/os/\$arch
Server = https://www.caco.ic.unicamp.br/archlinux/\$repo/os/\$arch
Server = https://mirror.xtom.com.hk/archlinux/\$repo/os/\$arch
Server = https://ftp.ek-cer.hu/pub/mirrors/ftp.archlinux.org/\$repo/os/\$arch
Server = https://nova.quantum-mirror.hu/mirrors/pub/archlinux/\$repo/os/\$arch
Server = https://super.quantum-mirror.hu/mirrors/pub/archlinux/\$repo/os/\$arch
Server = https://is.mirror.flokinet.net/archlinux/\$repo/os/\$arch
Server = https://mirrors.opensource.is/archlinux/\$repo/os/\$arch
Server = https://mirror.system.is/arch/\$repo/os/\$arch
Server = https://mirror.4v1.in/archlinux/\$repo/os/\$arch
Server = https://mirror.abhy.me/archlinux/\$repo/os/\$arch
Server = https://mirror.albony.in/archlinux/\$repo/os/\$arch
Server = https://mirror.maa.albony.in/archlinux/\$repo/os/\$arch
Server = https://mirror.nag.albony.in/archlinux/\$repo/os/\$arch
Server = https://in.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://in-mirror.garudalinux.org/archlinux/\$repo/os/\$arch
Server = https://archlinux.mirror.net.in/archlinux/\$repo/os/\$arch
Server = https://in.arch.niranjan.co/\$repo/os/\$arch
Server = https://mirror.repository.id/archlinux/\$repo/os/\$arch
Server = https://mirror.telkomuniversity.ac.id/archlinux/\$repo/os/\$arch
Server = https://kacabenggala.uny.ac.id/archlinux/\$repo/os/\$arch
Server = https://mirror.arvancloud.ir/archlinux/\$repo/os/\$arch
Server = https://mirror.bardia.tech/archlinux/\$repo/os/\$arch
Server = https://mirror.hakimi-soft.ir/archlinux/\$repo/os/\$arch
Server = https://mirror.hostiran.ir/archlinux/\$repo/os/\$arch
Server = https://mirror.mobinhost.com/archlinux/\$repo/os/\$arch
Server = https://archlinux.interhost.co.il/\$repo/os/\$arch
Server = https://mirror.isoc.org.il/pub/archlinux/\$repo/os/\$arch
Server = https://archlinux.mivzakim.net/\$repo/os/\$arch
Server = https://it.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://arch.mirror.hyperbit.it/\$repo/os/\$arch
Server = https://mala-arch-server.eu/\$repo/os/\$arch
Server = https://archlinux.mirror.server24.net/\$repo/os/\$arch
Server = https://mirror.aria-on-the-planet.es/archlinux/\$repo/os/\$arch
Server = https://mirror.cat.net/archlinux/\$repo/os/\$arch
Server = https://jp.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.hashy0917.net/archlinux/\$repo/os/\$arch
Server = https://ftp.jaist.ac.jp/pub/Linux/ArchLinux/\$repo/os/\$arch
Server = https://repo.jing.rocks/archlinux/\$repo/os/\$arch
Server = https://www.miraa.jp/archlinux/\$repo/os/\$arch
Server = https://mirror.nishi.network/archlinux/\$repo/os/\$arch
Server = https://mirror.saebasol.org/archlinux/\$repo/os/\$arch
Server = https://mirror.hoster.kz/archlinux/\$repo/os/\$arch
Server = https://mirror.ps.kz/archlinux/\$repo/os/\$arch
Server = https://archlinux.mirror.liquidtelecom.com/\$repo/os/\$arch
Server = https://mirror.abderraziq.com/archlinux/\$repo/os/\$arch
Server = https://mirrors.nepalicloud.com/archlinux/\$repo/os/\$arch
Server = https://mirror.bouwhuis.network/archlinux/\$repo/os/\$arch
Server = https://mirror.nl.cdn-perfprod.com/archlinux/\$repo/os/\$arch
Server = https://nl.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.cj2.nl/archlinux/\$repo/os/\$arch
Server = https://mirrors.daan.vodka/archlinux/\$repo/os/\$arch
Server = https://nl.mirror.flokinet.net/archlinux/\$repo/os/\$arch
Server = https://mirror.i3d.net/pub/archlinux/\$repo/os/\$arch
Server = https://mirror.serverion.com/archlinux/\$repo/os/\$arch
Server = https://mirror.tarellia.net/distr/archlinux/\$repo/os/\$arch
Server = https://mirrors.xtom.nl/archlinux/\$repo/os/\$arch
Server = https://archlinux.nautile.nc/archlinux/\$repo/os/\$arch
Server = https://mirror.2degrees.nz/archlinux/\$repo/os/\$arch
Server = https://mirror.0xem.ma/arch/\$repo/os/\$arch
Server = https://mirror.acadielinux.ca/mirror/arch/\$repo/os/\$arch
Server = https://mirror.accuris.ca/archlinux/\$repo/os/\$arch
Server = https://mirror.fsmg.org.nz/archlinux/\$repo/os/\$arch
Server = https://archlinux.ourhome.kiwi/\$repo/os/\$arch
Server = https://mirror.smith.geek.nz/archlinux/\$repo/os/\$arch
Server = https://mirror.t-home.mk/archlinux/\$repo/os/\$arch
Server = https://mirror.archlinux.no/\$repo/os/\$arch
Server = https://lysakermoen.com/Software/Linux/Mirrors/ArchLinux/\$repo/os/\$arch
Server = https://mirror.neuf.no/archlinux/\$repo/os/\$arch
Server = https://mirror.eloteam.tk/archlinux/\$repo/os/\$arch
Server = https://ftp.icm.edu.pl/pub/Linux/dist/archlinux/\$repo/os/\$arch
Server = https://mirrors.nxthost.com/archlinux/\$repo/os/\$arch
Server = https://mirrors.pidginhost.com/arch/\$repo/os/\$arch
Server = https://archlinux.gay/archlinux/\$repo/os/\$arch
Server = https://ru.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.kamtv.ru/archlinux/\$repo/os/\$arch
Server = https://mirror.kpfu.ru/archlinux/\$repo/os/\$arch
Server = https://mirror.nw-sys.ru/archlinux/\$repo/os/\$arch
Server = https://repository.su/archlinux/\$repo/os/\$arch
Server = https://mirror.rol.ru/archlinux/\$repo/os/\$arch
Server = https://web.sketserv.ru/archlinux/\$repo/os/\$arch
Server = https://mirror2.sl-chat.ru/archlinux/\$repo/os/\$arch
Server = https://mirror3.sl-chat.ru/archlinux/\$repo/os/\$arch
Server = https://mirror.truenetwork.ru/archlinux/\$repo/os/\$arch
Server = https://mirror.yandex.ru/archlinux/\$repo/os/\$arch
Server = https://sa.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror1.sox.rs/archlinux/\$repo/os/\$arch
Server = https://mirror.aktkn.sg/archlinux/\$repo/os/\$arch
Server = https://sg.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://download.nus.edu.sg/mirror/archlinux/\$repo/os/\$arch
Server = https://mirror.freedif.org/archlinux/\$repo/os/\$arch
Server = https://singapore.mirror.pkgbuild.com/\$repo/os/\$arch
Server = https://mirror.guillaumea.fr/archlinux/\$repo/os/\$arch
Server = https://mirror.jingk.ai/archlinux/\$repo/os/\$arch
Server = https://sg.arch.niranjan.co/\$repo/os/\$arch
Server = https://mirror.sg.gs/archlinux/\$repo/os/\$arch
Server = https://mirror.lnx.sk/pub/linux/archlinux/\$repo/os/\$arch
Server = https://www.sooftware.com/mirrors/Arch-Linux/\$repo/os/\$arch
Server = https://mirror.tux.si/arch/\$repo/os/\$arch
Server = https://archlinux.za.mirror.allworldit.com/archlinux/\$repo/os/\$arch
Server = https://za.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://johannesburg.mirror.pkgbuild.com/\$repo/os/\$arch
Server = https://mirrors.urbanwave.co.za/archlinux/\$repo/os/\$arch
Server = https://kr.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.funami.tech/arch/\$repo/os/\$arch
Server = https://ftp.harukasan.org/archlinux/\$repo/os/\$arch
Server = https://ftp.lanet.kr/pub/archlinux/\$repo/os/\$arch
Server = https://mirror.morgan.kr/archlinux/\$repo/os/\$arch
Server = https://mirror.siwoo.org/archlinux/\$repo/os/\$arch
Server = https://mirror.yuki.net.uk/archlinux/\$repo/os/\$arch
Server = https://es.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.cloroformo.org/archlinux/\$repo/os/\$arch
Server = https://mirror.librelabucm.org/archlinux/\$repo/os/\$arch
Server = https://mirrors.marquitos.space/archlinux/\$repo/os/\$arch
Server = https://nox.panibrez.com/archlinux/\$repo/os/\$arch
Server = https://mirror.raiolanetworks.com/archlinux/\$repo/os/\$arch
Server = https://mirror.accum.se/mirror/archlinux/\$repo/os/\$arch
Server = https://mirror.braindrainlan.nu/archlinux/\$repo/os/\$arch
Server = https://ftp.ludd.ltu.se/mirrors/archlinux/\$repo/os/\$arch
Server = https://ftp.lysator.liu.se/pub/archlinux/\$repo/os/\$arch
Server = https://mirror.bahnhof.net/pub/archlinux/\$repo/os/\$arch
Server = https://ftp.myrveln.se/pub/linux/archlinux/\$repo/os/\$arch
Server = https://mirror.osbeck.com/archlinux/\$repo/os/\$arch
Server = https://pkg.adfinis-on-exoscale.ch/archlinux-pkgbuild/\$repo/os/\$arch
Server = https://pkg.adfinis-on-exoscale.ch/archlinux/\$repo/os/\$arch
Server = https://arch.mirror.winslow.cloud/\$repo/os/\$arch
Server = https://ca.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.cpsc.ucalgary.ca/mirror/archlinux.org/\$repo/os/\$arch
Server = https://mirror.csclub.uwaterloo.ca/archlinux/\$repo/os/\$arch
Server = https://mirror2.evolution-host.com/archlinux/\$repo/os/\$arch
Server = https://mirror.ext4.xyz/archlinux/\$repo/os/\$arch
Server = https://mirror.franscorack.com/archlinux/\$repo/os/\$arch
Server = https://mirror.quantum5.ca/archlinux/\$repo/os/\$arch
Server = https://muug.ca/mirror/archlinux/\$repo/os/\$arch
Server = https://mirrors.nix.org.ua/linux/archlinux/\$repo/os/\$arch
Server = https://mirrors.reitarovskyi.tech/archlinux/\$repo/os/\$arch
Server = https://mirror.hafeezh.com/archlinux/\$repo/os/\$arch
Server = https://archlinux.uk.mirror.allworldit.com/archlinux/\$repo/os/\$arch
Server = https://mirror.bytemark.co.uk/archlinux/\$repo/os/\$arch
Server = https://repo.c48.uk/arch/\$repo/os/\$arch
Server = https://gb.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://london.mirror.pkgbuild.com/\$repo/os/\$arch
Server = https://mirrors.gethosted.online/archlinux/\$repo/os/\$arch
Server = https://mirrors.melbourne.co.uk/archlinux/\$repo/os/\$arch
Server = https://mirror.infernocomms.net/archlinux/\$repo/os/\$arch
Server = https://www.mirrorservice.org/sites/ftp.archlinux.org/\$repo/os/\$arch
Server = https://mirror.netweaver.uk/archlinux/\$repo/os/\$arch
Server = https://lon.mirror.rackspace.com/archlinux/\$repo/os/\$arch
Server = https://mirror.server.net/archlinux/\$repo/os/\$arch
Server = https://repo.slithery.uk/\$repo/os/\$arch
Server = https://mirror.st2projects.com/archlinux/\$repo/os/\$arch
Server = https://mirrors.ukfast.co.uk/sites/archlinux.org/\$repo/os/\$arch
Server = https://mirror.cov.ukservers.com/archlinux/\$repo/os/\$arch
Server = https://mirror.vinehost.net/archlinux/\$repo/os/\$arch
Server = https://mirrors.xhosts.co.uk/arch/\$repo/os/\$arch
Server = https://mirror.adectra.com/archlinux/\$repo/os/\$arch
Server = https://mirror.akane.network/archmirror/\$repo/os/\$arch
Server = https://mirror.arizona.edu/archlinux/\$repo/os/\$arch
Server = https://arlm.tyzoid.com/\$repo/os/\$arch
Server = https://mirror.ava.dev/archlinux/\$repo/os/\$arch
Server = https://mirrors.bjg.at/arch/\$repo/os/\$arch
Server = https://mirrors.bloomu.edu/archlinux/\$repo/os/\$arch
Server = https://arch-mirror.brightlight.today/\$repo/os/\$arch
Server = https://us.mirrors.cicku.me/archlinux/\$repo/os/\$arch
Server = https://mirror.clarkson.edu/archlinux/\$repo/os/\$arch
Server = https://mirror.colonelhosting.com/archlinux/\$repo/os/\$arch
Server = https://arch.mirror.constant.com/\$repo/os/\$arch
Server = https://mirror.cybersecurity.nmt.edu/archlinux/\$repo/os/\$arch
Server = https://mirror.ette.biz/archlinux/\$repo/os/\$arch
Server = https://mirror.wdc1.us.leaseweb.net/archlinux/\$repo/os/\$arch
Server = https://mirror.lty.me/archlinux/\$repo/os/\$arch
Server = https://mirrors.lug.mtu.edu/archlinux/\$repo/os/\$arch
Server = https://m.lqy.me/arch/\$repo/os/\$arch
Server = https://archlinux.macarne.com/\$repo/os/\$arch
Server = https://arch-mirror.marcusspencer.xyz:4443/archlinux/\$repo/os/\$arch
Server = https://arch.miningtcup.me/\$repo/os/\$arch
Server = https://mirror.kaminski.io/archlinux/\$repo/os/\$arch
Server = https://iad.mirrors.misaka.one/archlinux/\$repo/os/\$arch
Server = https://mirrors.mit.edu/archlinux/\$repo/os/\$arch
Server = https://mirrors.pablonara.com/archlinux/\$repo/os/\$arch
Server = https://upstream-1.pablonara.com/archlinux/\$repo/os/\$arch
Server = https://mirror.powerfly.ca/archlinux/\$repo/os/\$arch
Server = https://mirror.scd31.com/arch/\$repo/os/\$arch
Server = https://mirror.xenyth.net/archlinux/\$repo/os/\$arch
Server = https://mirror.yuri.so/arch/\$repo/os/\$arch
Server = https://mirror.anquan.cl/archlinux/\$repo/os/\$arch
Server = https://elmirror.cl/archlinux/\$repo/os/\$arch
Server = https://mirror.hnd.cl/archlinux/\$repo/os/\$arch
Server = https://mirror.ufro.cl/archlinux/\$repo/os/\$arch
Server = https://mirror.aliyun.com/archlinux/\$repo/os/\$arch
Server = https://mirrors.bfsu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.cqu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.hit.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.hust.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.jcut.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.jlu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.jxust.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.neusoft.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.nju.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.njupt.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirror.nyist.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.qlu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.qvq.net.cn/archlinux/\$repo/os/\$arch
Server = https://mirror.redrock.team/archlinux/\$repo/os/\$arch
Server = https://mirrors.shanghaitech.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.sjtug.sjtu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.tuna.tsinghua.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.ustc.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.wsyu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.xjtu.edu.cn/archlinux/\$repo/os/\$arch
Server = https://mirrors.atlas.net.co/archlinux/\$repo/os/\$arch
Server = https://edgeuno-bog2.mm.fcix.net/archlinux/\$repo/os/\$arch
Server = https://mirror.dkm.cz/archlinux/\$repo/os/\$arch
Server = https://europe.mirror.pkgbuild.com/\$repo/os/\$arch
Server = https://gluttony.sin.cvut.cz/arch/\$repo/os/\$arch
Server = https://mirror.it4i.cz/arch/\$repo/os/\$arch
EOF

          # Используем оригинальный pacman.conf ArchISO
          cp /usr/share/archiso/configs/releng/pacman.conf pacman.conf

          # Замена брендинга
          find . -type f -exec sed -i \
            -e 's/Arch Linux/Arcalm Linux/g' \
            -e 's/archlinux/arcalm/g' \
            -e 's/ARCH_/ARCALM_/g' {} \;

          # Добавление пакетов
          echo -e "calamares\nqt5-xmlpatterns\nkpmcore\nxorg-xinit\nsddm\nplasma-meta\nkde-applications-meta\nnetworkmanager\ngrub\nefibootmgr\nxdg-desktop-portal-kde" >> packages.x86_64

          # Копирование конфигов Calamares
          mkdir -p airootfs/etc/calamares
          if [ -d "/__w/arcalm/arcalm/calamares" ]; then
            cp -rv "/__w/arcalm/arcalm/calamares"/* airootfs/etc/calamares/
          else
            echo "::error::Missing Calamares config directory!"
            exit 1
          fi

          # Копирование скрипта customize_airootfs.sh
          mkdir -p airootfs/root
          if [ -f "/__w/arcalm/arcalm/airootfs/root/customize_airootfs.sh" ]; then
            cp -v "/__w/arcalm/arcalm/airootfs/root/customize_airootfs.sh" airootfs/root/
            chmod +x airootfs/root/customize_airootfs.sh
          else
            echo "::warning::Customize script not found, skipping"
          fi

          # Настройка метки ISO
          echo "MKISOFS_ARGS=\"-V ARCALM_$(date +%Y.%m.%d)\"" >> config.sh

      - name: Build ISO
        run: |
          mkarchiso -v -w /work -o /out /build/custom-archiso
          ISO_FILE=$(ls /out/*.iso)
          echo "ISO_FILE=$ISO_FILE" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check-version.outputs.arch_version }}
          name: "Arcalm Linux ${{ needs.check-version.outputs.arch_version }}"
          body: "Custom Arch-based Linux with Calamares installer"
          files: ${{ env.ISO_FILE }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old releases
        if: success()
        run: |
          mapfile -t releases < <(
            curl -sH "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100" | jq -r '.[].id'
          )
          if [ "${#releases[@]}" -gt 3 ]; then
            for release_id in "${releases[@]:3}"; do
              curl -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/$release_id"
            done
          fi